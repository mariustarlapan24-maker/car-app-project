<%- include('partials/header', { title: title }) %>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 text-center"><%= title %></h5>
                </div>
                
                <div id="chat-messages" class="card-body overflow-auto" style="height: 400px; background-color: #f8f9fa;">
                    <div class="text-center text-muted small mb-3">Sunteți în camera: <%= roomId %></div>
                    <div id="messages-list">
                        </div>
                </div>

                <div class="card-footer bg-white border-top-0 p-3">
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control rounded-pill border-2" placeholder="Scrie un mesaj..." autocomplete="off" required>
                        <button type="submit" class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const roomId = "<%= roomId %>";
    const username = "<%= username %>";
    const userId = "<%= userId %>"; // Adăugat pentru a putea trimite ID-ul către server

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('chat-messages');
    const messagesList = document.getElementById('messages-list');

    // Funcție universală pentru a desena un mesaj pe ecran
    function appendMessage(data) {
        const div = document.createElement('div');
        
        // Verificăm cine a trimis mesajul pentru a decide alinierea
        // Verificăm ambele variante (senderName sau sender) pentru compatibilitate cu istoricul și live
        const isMe = (data.senderName === username);
        
        div.className = `mb-3 d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}`;
        
        // Formatăm ora
        let timeStr = "";
        try {
            const date = data.timestamp ? new Date(data.timestamp) : new Date();
            timeStr = date.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });
        } catch(e) { 
            timeStr = "--:--"; 
        }

        div.innerHTML = `
            <div class="p-2 px-3 rounded-4 shadow-sm" style="max-width: 75%; background-color: ${isMe ? '#0d6efd' : '#ffffff'}; color: ${isMe ? '#fff' : '#000'}">
                <small class="d-block fw-bold border-bottom mb-1" style="font-size: 0.7em; opacity: 0.8;">
                    ${data.senderName || "Utilizator"}
                </small>
                <span>${data.text}</span>
            </div>
            <small class="text-muted mt-1" style="font-size: 0.6em;">${timeStr}</small>
        `;
        
        messagesList.appendChild(div);
        
        // Scroll automat la ultimul mesaj
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 1. Încărcăm istoricul (transmis de server ca JSON securizat)
    const rawHistory = '<%- JSON.stringify(oldMessages) %>';
    try {
        const history = JSON.parse(rawHistory);
        if (Array.isArray(history)) {
            history.forEach(msg => {
                // Ne asigurăm că trimitem obiectul cu structura așteptată de appendMessage
                appendMessage(msg);
            });
        }
    } catch (err) {
        console.error("Eroare la procesarea istoricului:", err);
    }

    // 2. Intră în cameră
    socket.emit('joinRoom', roomId);

    // 3. Trimite mesaj
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = messageInput.value;
        if (msg.trim()) {
            socket.emit('chatMessage', {
                roomId: roomId,
                message: msg,
                senderName: username,
                userId: userId
            });
            messageInput.value = '';
            messageInput.focus();
        }
    });

    // 4. Primește mesaj live (Sincronizat cu emit-ul din server.js)
    socket.on('message', (data) => {
        appendMessage({
            senderName: data.senderName, // Folosim senderName așa cum trimite serverul
            text: data.text,
            timestamp: data.timestamp
        });
    });
</script>

<%- include('partials/footer') %>