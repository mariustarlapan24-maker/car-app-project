<%- include('partials/header', { title: title }) %>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-dark text-white py-3">
                    <h6 class="mb-0"><i class="bi bi-chat-left-text-fill me-2"></i>Mesaje Recente</h6>
                </div>
                <div class="list-group list-group-flush overflow-auto" style="max-height: 500px;">
                    <a href="/chat" class="list-group-item list-group-item-action py-3 <%= roomId === 'general' ? 'active bg-primary border-primary' : '' %>">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h6 class="mb-1 fw-bold">Chat General</h6>
                            <i class="bi bi-globe2"></i>
                        </div>
                        <small class="<%= roomId === 'general' ? 'text-white-50' : 'text-muted' %>">Discuții cu toți utilizatorii</small>
                    </a>

                    <% if (inbox && inbox.length > 0) { %>
                        <% inbox.forEach(item => { %>
                            <a href="/chat/private/<%= item.roomId %>" class="list-group-item list-group-item-action py-3 <%= roomId === item.roomId ? 'active bg-primary border-primary' : '' %>">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 fw-bold">
                                        <%= item.carPlate %>
                                        <% if (item.isNew && roomId !== item.roomId) { %>
                                            <span class="badge rounded-pill bg-danger ms-1" style="font-size: 0.6em;">NOU</span>
                                        <% } %>
                                    </h6>
                                    <small class="<%= roomId === item.roomId ? 'text-white-50' : 'text-muted' %>">
                                        <%= new Date(item.timestamp).toLocaleTimeString('ro-RO', {hour: '2-digit', minute:'2-digit'}) %>
                                    </small>
                                </div>
                                <p class="mb-1 small text-truncate <%= roomId === item.roomId ? 'text-white' : '' %>" style="max-width: 100%;">
                                    <%= item.lastMessage %>
                                </p>
                            </a>
                        <% }) %>
                    <% } else { %>
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-chat-dots d-block mb-2 fs-4"></i>
                            <small>Nicio conversație privată încă.</small>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 text-center"><%= title %></h5>
                </div>
                
                <div id="chat-messages" class="card-body overflow-auto" style="height: 400px; background-color: #f8f9fa;">
                    <div class="text-center text-muted small mb-3">Sunteți în: <%= title %></div>
                    <div id="messages-list">
                        </div>
                </div>

                <div class="card-footer bg-white border-top-0 p-3">
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control rounded-pill border-2" placeholder="Scrie un mesaj..." autocomplete="off" required>
                        <button type="submit" class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const roomId = "<%= roomId %>";
    const username = "<%= username %>";
    const userId = "<%= userId %>";

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('chat-messages');
    const messagesList = document.getElementById('messages-list');

    // CORECT: Funcția primește și parametrul shouldAnimate (setat pe true implicit)
    function appendMessage(data, shouldAnimate = true) {
        const div = document.createElement('div');
        const isMe = (data.senderName === username);
    
        div.className = `mb-3 d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}`;
    
        // (Aici rămâne codul tău pentru timeStr și div.innerHTML neschimbat)
        let timeStr = "";
        try {
            const date = data.timestamp ? new Date(data.timestamp) : new Date();
            timeStr = date.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });
        } catch(e) { timeStr = "--:--"; }

        div.innerHTML = `
            <div class="p-2 px-3 rounded-4 shadow-sm" style="max-width: 75%; background-color: ${isMe ? '#0d6efd' : '#ffffff'}; color: ${isMe ? '#fff' : '#000'}">
                <small class="d-block fw-bold border-bottom mb-1" style="font-size: 0.7em; opacity: 0.8;">
                    ${data.senderName || "Utilizator"}
                </small>
                <span>${data.text}</span>
            </div>
            <small class="text-muted mt-1" style="font-size: 0.6em;">${timeStr}</small>
        `;

        // --- LOGICA CORECTĂ PENTRU ANIMAȚIE ---
        if (shouldAnimate) {
            // Dacă este mesaj nou, îl facem invizibil întâi
            div.style.opacity = '0';
            div.style.transform = 'translateY(10px)';
            div.style.transition = 'all 0.3s ease';
        
            messagesList.appendChild(div);

            setTimeout(() => {
                div.style.opacity = '1';
                div.style.transform = 'translateY(0)';
            }, 10);
        } else {
            // Dacă este din istoric (false), îl punem direct fără stiluri de animație
            messagesList.appendChild(div);
        }

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Folosim JSON.parse pe un string generat de EJS. 
    // Folosim backticks (`) pentru a evita problemele cu ghilimelele din mesaje.
    const historyData = `<%- JSON.stringify(oldMessages || []) %>`;
    const history = JSON.parse(historyData);

    // --- PUNE ACEST BLOC NOU AICI ---
    if (Array.isArray(history)) {
        history.forEach(msg => {
            appendMessage(msg, false); // 'false' spune funcției să nu animeze istoricul
        });
    
        setTimeout(() => {
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }, 100);
    }
    socket.emit('joinRoom', roomId);

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = messageInput.value;
        if (msg.trim()) {
            socket.emit('chatMessage', {
                roomId: roomId,
                message: msg,
                senderName: username,
                userId: userId
            });
            messageInput.value = '';
            messageInput.focus();
        }
    });

    socket.on('message', (data) => {
        appendMessage(data); // Aici shouldAnimate va fi automat true
    });
</script>

<%- include('partials/footer') %>