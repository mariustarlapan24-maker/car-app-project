// 1. Chat General
app.get('/chat', (req, res)=> {
    if (!req.session.userId) return res.redirect('/login');
    res.render('chat', {
        title: 'Chat General',
        userId: req.session.userId,
        // Am adăugat .toString() aici:
        username: 'User_' + req.session.userId.toString().substring(0, 4),
        roomId: 'general'
    });
});

// 2. Chat Privat
app.get('/chat/private/:carId', async (req, res) => {
    if (!req.session.userId) return res.redirect('/login');
    try {
        const carId = req.params.carId;
        if (!mongoose.Types.ObjectId.isValid(carId)) return res.status(400).send("ID invalid.");

        const car = await Car.findById(carId);
        if (!car) return res.status(404).send("Mașina nu există.");

        res.render('chat', {
            title: `Chat: ${car.plateNumber}`,
            userId: req.session.userId,
            // Și aici am adăugat .toString():
            username: 'User_' + req.session.userId.toString().substring(0, 4),
            roomId: carId.toString()
        });
    } catch (err) {
        console.error("Eroare la deschiderea chat-ului privat:", err);
        res.status(500).send("Eroare de server.");
    }
});