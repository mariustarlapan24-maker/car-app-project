<%- include('partials/header', { title: title }) %>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 text-center"><%= title %></h5>
                </div>
                
                <div id="chat-messages" class="card-body overflow-auto" style="height: 400px; background-color: #f8f9fa;">
                    <div class="text-center text-muted small mb-3">Sunteți în camera: <%= roomId %></div>
                    <div id="messages-list"></div>
                </div>

                <div class="card-footer bg-white border-top-0 p-3">
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control rounded-pill border-2" placeholder="Scrie un mesaj..." autocomplete="off" required>
                        <button type="submit" class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const roomId = "<%= roomId %>";
    const userId = "<%= userId %>";
    const username = "<%= username %>";

    // DEFINIM ELEMENTELE MAI ÎNTÂI
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('chat-messages');
    const messagesList = document.getElementById('messages-list');

    // ACUM PUTEM FACE SCROLL (după ce elementul e definit)
    window.onload = () => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    // 1. Intră în camera specifică
    socket.emit('joinRoom', roomId);

    // 2. Trimiterea mesajului
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = messageInput.value;
        if (msg.trim()) {
            socket.emit('chatMessage', {
                roomId: roomId,
                userId: userId,
                message: msg,
                senderName: username
            });
            messageInput.value = '';
            messageInput.focus();
        }
    });

    // 3. Primirea mesajului
    socket.on('message', (data) => {
        const div = document.createElement('div');
        const isMe = data.sender === username;
        
        div.className = `mb-3 d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}`;
        
        div.innerHTML = `
            <div class="p-2 px-3 rounded-4 shadow-sm" style="max-width: 75%; background-color: ${isMe ? '#0d6efd' : '#ffffff'}; color: ${isMe ? '#fff' : '#000'}">
                <small class="d-block fw-bold border-bottom mb-1" style="font-size: 0.7em; opacity: 0.8;">${data.sender}</small>
                <span>${data.text}</span>
            </div>
            <small class="text-muted mt-1" style="font-size: 0.6em;">${data.time}</small>
        `;
        
        if (messagesList) {
            messagesList.appendChild(div);
        }
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
</script>

<%- include('partials/footer') %>
