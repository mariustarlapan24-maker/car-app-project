<%- include('partials/header', { title: 'Acasă' }) %>

<% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
        Mașina a fost înregistrată cu succes!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div class="row justify-content-center pt-5 pb-5"> 
    <div class="col-12 col-md-8 col-lg-6">
        <div class="input-group position-relative shadow-lg rounded-pill bg-white">
            <span class="input-group-text bg-transparent rounded-start-pill py-2 border-0">
                <div class="d-flex flex-column align-items-center me-2 flag-input-box">
                    <img src="/img/drapel-md.png" class="flag-icon me-1" style="width: 20px;">
                    <span class="fw-bold text-dark" style="font-size: 0.7em;">MD</span>
                </div>
            </span>
            
            <input type="text" id="plate-search" name="plateNumber" class="form-control rounded-0 border-0" 
                   placeholder="Caută după număr (Ex: ABC 123)" style="height: 50px;" autocomplete="off">
                   
            <button id="clear-search" class="btn btn-transparent rounded-end-pill" type="button">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <ul id="search-results" class="list-group position-absolute w-100 mt-5 shadow-lg z-3"></ul>
        </div>
    </div>
</div>

<h2 class="text-center mb-4 fw-bold">Lista Tuturor Mașinilor</h2>

<div class="cars-grid-container">
    <% if (cars && cars.length > 0) { %>
        <div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mb-5">
            <% cars.forEach(car => { %>
                <div class="col">
                    <a href="/car/<%= car._id %>" class="text-decoration-none text-dark d-block">
                        <div class="card shadow-sm h-100 border-0 overflow-hidden">
                            <img src="<%= car.imageUrls[0] %>" class="card-img-top" alt="<%= car.make %>" style="height: 100px; object-fit: cover;">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-start">
                                    <div class="d-flex flex-column align-items-center me-2">
                                        <img src="/img/drapel-md.png" style="width: 15px;">
                                        <span class="fw-bold" style="font-size: 0.6em;">MD</span>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-primary" style="font-size: 0.9em;"><%= car.plateNumber %></div>
                                        <div class="text-muted" style="font-size: 0.75em;"><%= car.make %> <%= car.model %></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            <% }) %>
        </div>
    <% } else { %>
        <p class="alert alert-info text-center">Nu există mașini înregistrate încă.</p>
    <% } %>
</div>

<%- include('partials/footer') %>

<script>
    const searchInput = document.getElementById('plate-search');
    const clearBtn = document.getElementById('clear-search');

    // Flag pentru a preveni bucla infinită de evenimente (recursion)
    let isProcessing = false;

    if (searchInput) {
        searchInput.addEventListener('input', function (e) {
            if (isProcessing) return;
            
            isProcessing = true;

            // 1. Curățăm intrarea (doar litere și cifre, max 6 caractere brute)
            let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
            
            // 2. Extragem literele (primele 3)
            let letters = val.substring(0, 3).replace(/[^A-Z]/g, '');
            
            // 3. Extragem cifrele (restul)
            let numbers = val.substring(letters.length).replace(/[^0-9]/g, '');
            
            // 4. Formăm rezultatul final: AAA 111
            let formatted = letters;
            if (numbers.length > 0) {
                formatted += " " + numbers;
            }

            // 5. Actualizăm valoarea câmpului doar dacă s-a schimbat
            if (e.target.value !== formatted) {
                e.target.value = formatted;
            }

            isProcessing = false;
            
            // Aici poți adăuga logica de filtrare AJAX pentru rezultate, dacă ai una
        });
    }

    if (clearBtn && searchInput) {
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchInput.focus();
            // Dacă ai rezultate de căutare afișate, ascunde-le aici
            const results = document.getElementById('search-results');
            if (results) results.innerHTML = '';
        });
    }
</script>