<%- include('partials/header', { title: 'Acasă' }) %>

<div class="row justify-content-center pt-5 pb-5"> 
    <div class="col-12 col-md-8 col-lg-6">
        <div class="input-group position-relative shadow-lg rounded-pill bg-white">
            <span class="input-group-text bg-transparent rounded-start-pill py-2 border-0">
                <div class="d-flex flex-column align-items-center me-2">
                    <img src="/img/drapel-md.png" style="width: 20px;">
                    <span class="fw-bold text-dark" style="font-size: 0.7em;">MD</span>
                </div>
            </span>
            
            <input type="text" id="plate-search" name="plateNumber" class="form-control rounded-0 border-0" 
                   placeholder="Caută după număr (Ex: ABC 123)" style="height: 50px;" autocomplete="off">
                   
            <button id="clear-search" class="btn btn-transparent rounded-end-pill" type="button">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
</div>

<div class="cars-grid-container px-3">
    <% if (cars && cars.length > 0) { %>
        <div class="row row-cols-2 row-cols-md-4 g-3 mb-5" id="cars-list">
            <% cars.forEach(car => { %>
                <div class="col car-item" data-plate="<%= car.plateNumber.replace(/\s/g, '').toUpperCase() %>">
                    <a href="/car/<%= car._id %>" class="text-decoration-none text-dark d-block">
                        <div class="card shadow-sm h-100 border-0 overflow-hidden">
                            <img src="<%= car.imageUrls[0] %>" class="card-img-top" style="height: 120px; object-fit: cover;">
                            <div class="card-body p-2 text-center">
                                <div class="fw-bold text-primary"><%= car.plateNumber %></div>
                                <small class="text-muted"><%= car.make %> <%= car.model %></small>
                            </div>
                        </div>
                    </a>
                </div>
            <% }) %>
        </div>
    <% } %>
</div>

<%- include('partials/footer') %>

<script>
    const searchInput = document.getElementById('plate-search');

    // VARIANTA RADICALĂ: Verificare automată la interval (Polling)
    // Aceasta nu depinde de evenimentele de tastatură, deci nu se poate bloca.
    setInterval(() => {
        if (!searchInput) return;
        
        let cursor = searchInput.selectionStart;
        let originalValue = searchInput.value;
        
        // Curățăm și formatăm
        let v = originalValue.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
        let letters = v.substring(0, 3).replace(/[^A-Z]/g, '');
        let numbers = v.substring(letters.length).replace(/[^0-9]/g, '');
        
        let formatted = letters;
        if (numbers.length > 0) formatted += " " + numbers;

        // Modificăm DOAR dacă este necesar
        if (originalValue !== formatted) {
            searchInput.value = formatted;
            
            // Păstrăm poziția cursorului
            if (originalValue.length < formatted.length && cursor === 3) {
                searchInput.setSelectionRange(cursor + 1, cursor + 1);
            } else {
                searchInput.setSelectionRange(cursor, cursor);
            }
        }
        
        // Logica de filtrare vizuală a mașinilor de pe pagină
        filterCars(formatted.replace(/\s/g, ''));
    }, 100); // Verifică de 10 ori pe secundă

    function filterCars(query) {
        const cars = document.querySelectorAll('.car-item');
        cars.forEach(car => {
            const plate = car.getAttribute('data-plate');
            if (plate.includes(query)) {
                car.style.display = 'block';
            } else {
                car.style.display = 'none';
            }
        });
    }

    // Butonul de ștergere
    document.getElementById('clear-search').addEventListener('click', () => {
        searchInput.value = '';
        filterCars('');
    });
</script>