<%- include('partials/header', { title: 'Adaugă Mașină' }) %>

<div class="row justify-content-center mt-5 mb-5">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow-lg p-4 border-0 rounded-4">
            <h2 class="card-title text-center mb-4 fw-bold text-primary">Adaugă o Mașină</h2>

            <% if(typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger border-0 shadow-sm" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i><%= error %>
                </div>
            <% } %>

            <form action="/add-car" method="POST" enctype="multipart/form-data" id="addCarForm">
                
                <div class="mb-3">
                    <label for="ownerEmail" class="form-label fw-bold">Email-ul tău</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input type="email" name="ownerEmail" id="ownerEmail" 
                               class="form-control" placeholder="exemplu@email.com" 
                               required>
                    </div>
                    <div class="form-text">Vei fi contactat prin acest email de către alți utilizatori.</div>
                </div>

                <div class="mb-3">
                    <label for="plateNumber" class="form-label fw-bold">Număr de Înmatriculare (Format MD)</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light border-end-0">
                            <div class="d-flex flex-column align-items-center">
                                <img src="/img/drapel-md.png" alt="MD" style="width: 20px;">
                                <span class="fw-bold" style="font-size: 0.6em;">MD</span>
                            </div>
                        </span>
                        <input type="text" name="plateNumber" id="plateNumber" 
                               class="form-control fw-bold text-primary" 
                               placeholder="ABC 123" 
                               maxlength="8" 
                               style="letter-spacing: 1px;"
                               required autocomplete="off">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="make" class="form-label fw-bold">Marca</label>
                    <select name="make" id="make" class="form-select form-select-lg" required>
                        <option value="" disabled selected>Selectează marca…</option>
                        <% if (typeof carDatabase !== 'undefined') { %>
                            <% Object.keys(carDatabase).sort().forEach(function(marca) { %>
                                <option value="<%= marca %>"><%= marca %></option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="model" class="form-label fw-bold">Modelul</label>
                    <select name="model" id="model" class="form-select form-select-lg" required>
                        <option value="" disabled selected>Selectează modelul…</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="carImage" class="form-label fw-bold">Imagini Mașină (Max 3)</label>
                    <input type="file" name="carImage" id="carImage" class="form-control" accept="image/*" multiple required>
                    <div class="form-text text-muted">Imaginile vor fi procesate prin ImageKit.io.</div>
                </div>

                <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm rounded-pill">
                    <i class="bi bi-plus-circle me-2"></i>Salvează Mașina
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // --- Logica Select Dinamic ---
    const makeSelect = document.getElementById('make');
    const modelSelect = document.getElementById('model');
    // Pasul 1: Punem datele într-un element ascuns (metodă mult mai sigură)
    const modelsDataRaw = `<%- JSON.stringify(carDatabase || {}) %>`;

    // Pasul 2: Îi spunem browserului să transforme textul în obiect JavaScript
    let modelsData = {};
    try {
        modelsData = JSON.parse(modelsDataRaw);
    } catch (e) {
        console.error("Eroare la încărcarea listei de mașini:", e);
        // Listă de rezervă în caz de eroare critică
        modelsData = { "Dacia": ["Logan", "Duster"], "Skoda": ["Octavia"] };
    }

    makeSelect.addEventListener('change', () => {
        const selectedMake = makeSelect.value;
        modelSelect.innerHTML = '<option value="" disabled selected>Selectează modelul…</option>';
    
        if (selectedMake && modelsData[selectedMake]) {
            modelSelect.disabled = false; // Deblocăm câmpul
            modelsData[selectedMake].sort().forEach(m => {
                const opt = new Option(m, m);
                modelSelect.add(opt);
            });
        }
    });

    // --- Limitare Imagini ---
    document.getElementById('carImage').addEventListener('change', function() {
        if (this.files.length > 3) {
            alert("Maximum 3 imagini permise!");
            this.value = "";
        }
    });

    // --- Formatare Automată Număr ---
    const plateInput = document.getElementById('plateNumber');
    plateInput.addEventListener('input', (e) => {
        let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        let letters = val.replace(/[0-9]/g, '').substring(0, 3);
        let numbers = val.replace(/[A-Z]/g, '').substring(0, 3);
        e.target.value = letters + (letters.length === 3 && numbers.length > 0 ? ' ' + numbers : numbers);
    });
</script>

<%- include('partials/footer') %>
