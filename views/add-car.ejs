<%- include('partials/header', { title: 'Adaugă Mașină' }) %>

<div class="row justify-content-center mt-5">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow-lg p-4 border-0">
            <h2 class="card-title text-center mb-4 fw-bold">Adaugă o Mașină</h2>
            
            <form action="/add-car" method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="plateNumber" class="form-label fw-bold">Număr de Înmatriculare</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light">
                            <img src="/img/drapel-md.png" style="width: 20px;">
                            <span class="fw-bold ms-1">MD</span>
                        </span>
                        <input type="text" name="plateNumber" id="plateNumber" class="form-control form-control-lg" placeholder="ABC 123" required autocomplete="off">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="make" class="form-label fw-bold">Marca</label>
                    <select name="make" id="make" class="form-select" required>
                        <option value="" disabled selected>Selectează marca…</option>
                        <option value="Audi">Audi</option>
                        <option value="BMW">BMW</option>
                        <option value="Mercedes">Mercedes</option>
                        <option value="Volkswagen">Volkswagen</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="model" class="form-label fw-bold">Modelul</label>
                    <select name="model" id="model" class="form-select" required>
                        <option value="" disabled selected>Selectează modelul…</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="carImage" class="form-label fw-bold">Imagini (Max 3)</label>
                    <input type="file" name="carImage" id="carImage" class="form-control" accept="image/*" multiple required>
                </div>

                <button type="submit" class="btn btn-primary w-100 btn-lg">Salvează Mașina</button>
            </form>
        </div>
    </div>
</div>

<script>
    const plateInput = document.getElementById('plateNumber');

    // SOLUȚIA ANTI-BLOCAJ: Folosim un flag pentru a preveni auto-declanșarea
    let isFormatting = false;

    if (plateInput) {
        plateInput.addEventListener('input', function(e) {
            if (isFormatting) return; // Dacă scriptul deja lucrează, ieșim
            
            isFormatting = true; // Blocăm alte execuții paralele

            let input = e.target;
            let start = input.selectionStart;
            let val = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // Limităm la 6 caractere brute
            val = val.substring(0, 6);

            // Separăm literele de cifre
            let letters = val.substring(0, 3).replace(/[^A-Z]/g, '');
            let numbers = val.substring(letters.length).replace(/[^0-9]/g, '');
            
            let formatted = letters;
            if (numbers.length > 0) {
                formatted += " " + numbers;
            }

            // Aplicăm valoarea
            input.value = formatted;

            // Repoziționăm cursorul corect
            if (val.length > 3 && start === 4) start++;
            input.setSelectionRange(start, start);

            isFormatting = false; // Deblocăm scriptul pentru următoarea tastă
        });
    }

    // Logica pentru modele (simplificată pentru test)
    const modelsData = {
        "Audi": ["A3","A4","A6","Q5"],
        "BMW": ["X1","X3","X5","M3"],
        "Mercedes": ["C200","E300","S500"],
        "Volkswagen": ["Golf","Passat","Tiguan"]
    };

    const makeSelect = document.getElementById('make');
    const modelSelect = document.getElementById('model');

    if (makeSelect) {
        makeSelect.addEventListener('change', () => {
            modelSelect.innerHTML = '<option value="" disabled selected>Selectează modelul…</option>';
            const models = modelsData[makeSelect.value] || [];
            models.forEach(m => {
                const option = document.createElement('option');
                option.value = m; option.text = m;
                modelSelect.add(option);
            });
        });
    }
</script>

<%- include('partials/footer') %>